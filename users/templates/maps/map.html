{% extends 'base.html' %}
{% load static i18n %}

{% block title %}{% trans "Smart Farm Map" %}{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    {% if user.user_type == 'GOVERNMENT' %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.fullscreen@2.0.0/Control.FullScreen.css" />
    {% endif %}
    <style>
        main { padding: 0; margin: 0; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { background: linear-gradient(135deg, #3498db, #2ecc71); color: white; padding: 20px 0; border-radius: 0 0 15px 15px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); margin-bottom: 20px; }
        h2 { margin: 0; font-size: 28px; letter-spacing: 0.5px; }
        .subtitle { font-size: 16px; opacity: 0.9; margin-top: 5px; }
        #map { height: 500px; width: 100%; border-radius: 15px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); margin-bottom: 20px; }
        .crop-selector-container { margin-bottom: 20px; display: flex; justify-content: center; gap: 10px; }
        #cropPreference, #filterCrop, #filterStatus { padding: 10px; border-radius: 5px; font-size: 16px; width: 200px; border: 1px solid #ddd; }
        .button-container { display: flex; justify-content: center; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; }
        button { padding: 12px 16px; border: none; cursor: pointer; border-radius: 8px; background-color: #3498db; color: white; font-size: 15px; transition: all 0.3s ease; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); display: flex; align-items: center; gap: 8px; }
        button:hover { background-color: #2980b9; transform: translateY(-2px); }
        button:active { transform: translateY(0); }
        button:disabled { background-color: #95a5a6; cursor: not-allowed; transform: none; }
        button.warning { background-color: #f39c12; }
        button.warning:hover { background-color: #e67e22; }
        .map-container { position: relative; }
        .legend { position: absolute; z-index: 1000; bottom: 30px; right: 30px; background: white; padding: 10px 15px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); font-size: 14px; }
        .legend-item { display: flex; align-items: center; margin: 5px 0; }
        .legend-color { width: 20px; height: 20px; border-radius: 50%; margin-right: 10px; }
        #coordinates-panel { background: white; padding: 12px 15px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .coordinates-info { font-size: 15px; }
        .coordinates-value { font-weight: bold; color: #3498db; }
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); overflow: auto; }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 80%; max-width: 600px; animation: modalopen 0.3s; }
        @keyframes modalopen { from {opacity: 0; transform: translateY(-50px);} to {opacity: 1; transform: translateY(0);} }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
        .modal-title { font-size: 20px; font-weight: bold; color: #2980b9; }
        .close-button { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; transition: color 0.3s; }
        .close-button:hover { color: #333; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #2c3e50; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; transition: border-color 0.3s; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #3498db; box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2); }
        .form-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .leaflet-popup-content-wrapper { border-radius: 10px; padding: 5px; }
        .leaflet-popup-content { margin: 10px 12px; line-height: 1.5; }
        .popup-title { font-weight: bold; margin-bottom: 5px; font-size: 16px; color: #2980b9; }
        .popup-content { font-size: 14px; }
        .prediction { margin-top: 10px; font-weight: bold; color: #2ecc71; }
        .prediction-error { color: #e74c3c; }
        .status-indicator { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 5px; }
        .status-green { background-color: #2ecc71; }
        .status-orange { background-color: #f39c12; }
        .status-red { background-color: #e74c3c; }
        .notification { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); z-index: 9999; opacity: 0; transition: opacity 0.3s ease-in-out; color: white; display: flex; align-items: center; gap: 10px; }
        .notification.show { opacity: 1; }
        .notification.success { background-color: #3498db; }
        .notification.error { background-color: #e74c3c; }
        .notification.warning { background-color: #f39c12; }
        .loading-spinner { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; display: none; padding: 25px; background: rgba(0, 0, 0, 0.85); border-radius: 15px; box-shadow: 0 0 20px rgba(0, 255, 255, 0.5); }
        .loading-spinner.active { display: flex; align-items: center; justify-content: center; gap: 10px; }
        .spinner-ring { width: 40px; height: 40px; border: 4px solid transparent; border-top: 4px solid #00ffff; border-right: 4px solid #00ccff; border-radius: 50%; animation: spin 1s linear infinite; }
        .spinner-text { color: #00ffff; font-size: 16px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .more-details-btn { background-color: #2980b9; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; margin-top: 10px; }
        .more-details-btn:hover { background-color: #1f6391; }
        .more-details-section { display: none; margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd; }
        .more-details-section.active { display: block; }
        .search-container { margin-bottom: 20px; display: flex; justify-content: center; gap: 10px; }
        #searchInput { padding: 10px; border-radius: 5px; font-size: 16px; width: 300px; border: 1px solid #ddd; }
        #searchButton { padding: 10px 20px; }
        .coord-input-container { margin-bottom: 20px; display: flex; justify-content: center; gap: 10px; }
        .coord-input { width: 120px; padding: 10px; border-radius: 5px; font-size: 16px; border: 1px solid #ddd; }
        #goToCoords { padding: 10px 20px; }
        .leaflet-control-layers { border-radius: 5px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .leaflet-control-fullscreen { border-radius: 5px; }
        .leaflet-control-scale { margin-bottom: 10px; }
        @media (max-width: 768px) {
            #map { height: 400px; }
            .button-container { justify-content: center; }
            button { padding: 10px 14px; font-size: 14px; }
            .modal-content { width: 90%; margin: 20% auto; }
            #searchInput { width: 200px; }
            .coord-input { width: 100px; }
        }
        @media (max-width: 600px) {
            .header { padding: 15px 0; }
            h2 { font-size: 22px; }
            .subtitle { font-size: 14px; }
            #map { height: 350px; }
            .button-container { flex-direction: column; gap: 8px; }
            button { width: 100%; justify-content: center; }
            .legend { bottom: 15px; right: 15px; padding: 8px 12px; font-size: 12px; }
            .search-container, .coord-input-container, .crop-selector-container { flex-direction: column; align-items: center; }
            #searchInput, #cropPreference, #filterCrop, #filterStatus { width: 100%; }
            .coord-input { width: 100%; }
        }
    </style>
{% endblock %}

{% block content %}
    <main>
        <div class="header">
            <div class="container">
                <h2>{% trans "Smart Farm Mapping System" %}</h2>
                <div class="subtitle">{% trans "Optimize your farming with crop yield and price predictions" %}</div>
            </div>
        </div>

        <div class="container">
            {% if user.user_type == 'GOVERNMENT' %}
            <div class="search-container">
                <input type="text" id="searchInput" placeholder="{% trans 'Search for a location (e.g., Kochi, Kerala)' %}" />
                <button id="searchButton"><i class="fas fa-search"></i> {% trans "Search" %}</button>
            </div>

            <div class="coord-input-container">
                <input type="number" id="latInput" class="coord-input" placeholder="{% trans 'Latitude' %}" step="any" />
                <input type="number" id="lonInput" class="coord-input" placeholder="{% trans 'Longitude' %}" step="any" />
                <button id="goToCoords"><i class="fas fa-map-pin"></i> {% trans "Go" %}</button>
            </div>

            <div class="crop-selector-container">
                <select id="cropPreference">
                    <option value="">{% trans "Select Crop" %}</option>
                    {% for value, label in crop_choices %}
                        <option value="{{ value }}">{{ label }}</option>
                    {% endfor %}
                </select>
                <select id="filterCrop">
                    <option value="">{% trans "Filter by Crop" %}</option>
                    {% for value, label in crop_choices %}
                        <option value="{{ value }}">{{ label }}</option>
                    {% endfor %}
                </select>
                <select id="filterStatus">
                    <option value="">{% trans "Filter by Status" %}</option>
                    <option value="green">{% trans "Good Condition" %}</option>
                    <option value="orange">{% trans "Moderate Risk" %}</option>
                    <option value="red">{% trans "High Risk" %}</option>
                </select>
            </div>
            {% elif user.user_type == 'FARMER' %}
            <div class="crop-selector-container">
                <select id="cropPreference">
                    <option value="">{% trans "Select Crop" %}</option>
                    {% for value, label in crop_choices %}
                        <option value="{{ value }}">{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            {% else %}
            <!-- Non-Profit: Simplified version -->
            <div class="crop-selector-container">
                <select id="cropPreference">
                    <option value="">{% trans "Select Crop" %}</option>
                    {% for value, label in crop_choices %}
                        <option value="{{ value }}">{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}

            <div id="coordinates-panel">
                <div class="coordinates-info">{% trans "Selected Location" %}: <span id="selected-location-text">{% trans "No location selected" %}</span></div>
                <div class="coordinates-value" id="coordinates-display"></div>
            </div>

            <div class="button-container">
                <button id="saveLocation"><i class="fas fa-save"></i> {% trans "Save Location" %}</button>
                <button id="currentLocation"><i class="fas fa-location-arrow"></i> {% trans "Use My Location" %}</button>
                <button id="resetMap" class="warning"><i class="fas fa-sync-alt"></i> {% trans "Reset Map" %}</button>
                <button id="addFarm"><i class="fas fa-plus"></i> {% trans "Add Farm" %}</button>
                {% if user.user_type == 'GOVERNMENT' %}
                <button id="viewAllFarms"><i class="fas fa-eye"></i> {% trans "View All Farms" %}</button>
                <button id="exportFarms"><i class="fas fa-download"></i> {% trans "Export Farms" %}</button>
                {% elif user.user_type == 'FARMER' %}
                <button id="viewAllFarms"><i class="fas fa-eye"></i> {% trans "View All Farms" %}</button>
                {% endif %}
                <a href="{% url 'maps:my-farms' %}" class="btn btn-primary"><i class="fas fa-tractor"></i> {% trans "My Farms" %}</a>
            </div>

            <div class="map-container">
                <div id="map"></div>
                <div class="loading-spinner" id="loadingSpinner">
                    <div class="spinner-ring"></div>
                    <span class="spinner-text">{% trans "Processing..." %}</span>
                </div>
                <div class="legend">
                    <div class="legend-item"><div class="legend-color status-green"></div> {% trans "Good Condition" %}</div>
                    <div class="legend-item"><div class="legend-color status-orange"></div> {% trans "Moderate Risk" %}</div>
                    <div class="legend-item"><div class="legend-color status-red"></div> {% trans "High Risk" %}</div>
                </div>
            </div>

            <div id="farmModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <span class="modal-title">{% trans "Add New Farm" %}</span>
                        <span class="close-button" id="closeFarmModal">×</span>
                    </div>
                    <form id="farmForm">
                        {% if user.user_type == 'FARMER' %}
                        <!-- Farmer: No farmName field per provided template -->
                        {% else %}
                        <!-- Non-Profit/Government: No farmName field -->
                        {% endif %}
                        <div class="form-group">
                            <label for="farmSize">{% trans "Farm Size (acres)" %}</label>
                            <input type="number" id="farmSize" name="farmSize" min="0" step="0.1" value="1.0" required>
                        </div>
                        <div class="form-group">
                            <label for="farmStatus">{% trans "Farm Status" %}</label>
                            <select id="farmStatus" name="farmStatus" required>
                                <option value="green">{% trans "Good Condition" %}</option>
                                <option value="orange">{% trans "Moderate Risk" %}</option>
                                <option value="red">{% trans "High Risk" %}</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="soilType">{% trans "Soil Type" %}</label>
                            <select id="soilType" name="soilType" required>
                                <option value="loamy">{% trans "Loamy" %}</option>
                                <option value="clay">{% trans "Clay" %}</option>
                                <option value="sandy">{% trans "Sandy" %}</option>
                                <option value="silt">{% trans "Silt" %}</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="climate">{% trans "Climate" %}</label>
                            <select id="climate" name="climate" required>
                                <option value="hot">{% trans "Hot" %}</option>
                                <option value="tropical">{% trans "Tropical" %}</option>
                                <option value="subtropical">{% trans "Subtropical" %}</option>
                                <option value="temperate">{% trans "Temperate" %}</option>
                                <option value="arid">{% trans "Arid" %}</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="userCropPreferences">{% trans "Crop Planted" %}</label>
                            <select id="userCropPreferences" name="userCropPreferences" required>
                                <option value="">{% trans "Select Crop" %}</option>
                                {% for value, label in crop_choices %}
                                    <option value="{{ value }}">{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="plantingDate">{% trans "Planting Date" %}</label>
                            <input type="date" id="plantingDate" name="plantingDate" required>
                        </div>
                        <div class="form-group">
                            <label for="yieldPerAcre">{% trans "Expected Yield (quintals/acre)" %}</label>
                            <input type="number" id="yieldPerAcre" name="yieldPerAcre" min="0" step="0.1" value="10.0" required>
                        </div>
                        <div class="form-group">
                            <label>{% trans "Farm Location" %}</label>
                            <div id="locationDisplay">{% trans "Please select a location on the map first" %}</div>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="warning" id="cancelFarm">{% trans "Cancel" %}</button>
                            <button type="submit" id="submitFarm">{% trans "Save Farm" %}</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>
{% endblock %}

{% block extra_js %}
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    {% if user.user_type == 'GOVERNMENT' %}
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script src="https://unpkg.com/leaflet.fullscreen@2.0.0/Control.FullScreen.js"></script>
    {% endif %}
    <script>
        const mapConfig = {
            defaultView: [10.8505, 76.2711], // Kerala-centric
            defaultZoom: 7,
            maxZoom: 18
        };
        const map = L.map('map', {
            zoomControl: true,
            {% if user.user_type == 'GOVERNMENT' %}
            fullscreenControl: true
            {% endif %}
        }).setView(mapConfig.defaultView, mapConfig.defaultZoom);
        let marker = null;
        let selectedLat = null;
        let selectedLon = null;
        let farmMarkers = [];
        let farmPolygons = [];

        // Base layers
        const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);
        {% if user.user_type == 'GOVERNMENT' %}
        const esriLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: '© Esri'
        });
        const weatherLayer = L.tileLayer('https://tile.openweathermap.org/map/precipitation_new/{z}/{x}/{y}.png?appid=YOUR_OPENWEATHERMAP_API_KEY', {
            attribution: '© OpenWeatherMap',
            opacity: 0.5
        });
        const baseLayers = {
            "OpenStreetMap": osmLayer,
            "Satellite Imagery": esriLayer
        };
        const overlays = {
            "Precipitation": weatherLayer
        };
        L.control.layers(baseLayers, overlays).addTo(map);
        L.control.scale({ metric: true, imperial: true }).addTo(map);
        {% endif %}

        const customIcon = L.icon({
            iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-icon.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
            shadowSize: [41, 41]
        });

        const statusIcons = {
            green: L.icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34]
            }),
            orange: L.icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-orange.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34]
            }),
            red: L.icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34]
            })
        };

        const cropHarvestDays = {
            'wheat': 120, 'rice': 120, 'corn': 100, 'barley': 120, 'oats': 120, 'sorghum': 110, 'millet': 100,
            'soybean': 120, 'peanut': 120, 'bean': 100, 'pea': 90, 'lentil': 100, 'chickpea': 100, 'mungbean': 90,
            'cotton': 180, 'sugarcane': 365, 'sunflower': 100, 'mustard': 120, 'sesame': 90, 'potato': 100,
            'tomato': 90, 'onion': 100, 'carrot': 100, 'cabbage': 90, 'cauliflower': 90, 'brinjal': 90, 'okra': 90,
            'spinach': 60, 'chilli': 150, 'bittergourd': 90, 'ridgegourd': 90, 'banana': 270, 'banana_robusta': 270,
            'banana_rasthali': 270, 'banana_poovan': 270, 'banana_nendran': 270, 'mango': 365, 'guava': 365,
            'papaya': 270, 'pomegranate': 365, 'jackfruit': 365, 'coconut': 365
        };

        function showNotification(message, type = "success") {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-exclamation-triangle'}"></i> ${message}`;
            document.body.appendChild(notification);
            setTimeout(() => notification.classList.add('show'), 10);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        async function checkLocation(lat, lng) {
            const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=10`;
            try {
                const response = await fetch(url, {
                    headers: { 'User-Agent': 'SmartFarmMap/1.0' }
                });
                const data = await response.json();
                const type = data.type || '';
                const displayName = data.display_name || '';
                const waterKeywords = ['sea', 'ocean', 'waterbody', 'lake', 'river', 'bay', 'gulf'];
                const isWater = waterKeywords.some(keyword => 
                    type.toLowerCase().includes(keyword) || 
                    displayName.toLowerCase().includes(keyword)
                );
                return { isWater, displayName };
            } catch (error) {
                console.error('Error fetching location data:', error);
                return { isWater: false, displayName: 'Unknown' };
            }
        }

        function updateCoordinatesDisplay() {
            const coordinatesDisplay = document.getElementById('coordinates-display');
            const selectedLocationText = document.getElementById('selected-location-text');
            const locationDisplay = document.getElementById('locationDisplay');
            if (selectedLat !== null && selectedLon !== null) {
                coordinatesDisplay.textContent = `Lat: ${selectedLat.toFixed(6)}, Lon: ${selectedLon.toFixed(6)}`;
                selectedLocationText.textContent = '{% trans "Location Selected" %}';
                if (locationDisplay) {
                    locationDisplay.textContent = `Lat: ${selectedLat.toFixed(6)}, Lon: ${selectedLon.toFixed(6)}`;
                    locationDisplay.style.color = '#2980b9';
                    locationDisplay.style.fontWeight = 'bold';
                }
            } else {
                coordinatesDisplay.textContent = '';
                selectedLocationText.textContent = '{% trans "No location selected" %}';
                if (locationDisplay) locationDisplay.textContent = '{% trans "Please select a location on the map first" %}';
            }
        }

        async function fetchPricePrediction(crop, plantingDate, farmId = null) {
            if (!crop || !plantingDate) {
                showNotification('{% trans "Please select a crop and planting date" %}', 'error');
                return null;
            }
            const spinner = document.getElementById('loadingSpinner');
            spinner.classList.add('active');
            try {
                const daysToHarvest = cropHarvestDays[crop] || 120;
                const planting = new Date(plantingDate);
                const harvestDate = new Date(planting.getTime() + daysToHarvest * 24 * 60 * 60 * 1000);
                const harvestDateStr = harvestDate.toISOString().split('T')[0];
                const payload = { crop, harvest_date: harvestDateStr };
                if (farmId) payload.farm_id = farmId;
                const response = await fetch('{% url "maps:get-price-prediction" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`Price fetch error: ${response.status}`);
                const priceData = await response.json();
                if (priceData.warning) {
                    showNotification(priceData.warning, 'warning');
                }
                return priceData;
            } catch (error) {
                showNotification(`{% trans "Error fetching price prediction" %}: ${error.message}`, 'error');
                return null;
            } finally {
                spinner.classList.remove('active');
            }
        }

        async function fetchMoreDetails(lat, lon) {
            try {
                const response = await fetch('{% url "maps:get-location-details" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ latitude: lat, longitude: lon, more_details: true })
                });
                if (!response.ok) throw new Error(`Details fetch error: ${response.status}`);
                return await response.json();
            } catch (error) {
                showNotification(`{% trans "Error fetching more details" %}: ${error.message}`, 'error');
                return null;
            }
        }

        async function showMoreDetails(lat, lon, button) {
            const section = document.getElementById(`more-details-${lat}-${lon}`);
            if (section.classList.contains('active')) {
                section.classList.remove('active');
                button.textContent = '{% trans "More Details" %}';
                return;
            }
            button.textContent = '{% trans "Loading..." %}';
            const data = await fetchMoreDetails(lat, lon);
            if (data) {
                section.innerHTML = `
                    <div><strong>{% trans "Soil Moisture" %}:</strong> ${data.soil.moisture.toFixed(1)}%</div>
                    <div><strong>{% trans "Sunlight Hours" %}:</strong> ${data.climate.sunlight_hours.toFixed(1)} hrs</div>
                    <div><strong>{% trans "Pest Risk" %}:</strong> ${data.pest_risk}</div>
                    <div><strong>{% trans "Water Availability" %}:</strong> ${data.water_availability.toFixed(0)} thousand L/ha</div>
                    <div><strong>{% trans "Elevation" %}:</strong> ${data.elevation.toFixed(0)} m</div>
                    <div><strong>{% trans "Wind Speed" %}:</strong> ${data.weather.wind_speed.toFixed(1)} m/s</div>
                `;
                section.classList.add('active');
                button.textContent = '{% trans "Hide Details" %}';
            } else {
                section.innerHTML = `<div>{% trans "Failed to load data" %}.</div>`;
                section.classList.add('active');
                button.textContent = '{% trans "More Details" %}';
            }
        }

        {% if user.user_type == 'GOVERNMENT' %}
        document.getElementById('searchButton').addEventListener('click', async () => {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) {
                showNotification('{% trans "Please enter a location" %}', 'warning');
                return;
            }
            const spinner = document.getElementById('loadingSpinner');
            spinner.classList.add('active');
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`, {
                    headers: { 'User-Agent': 'SmartFarmMap/1.0' }
                });
                const results = await response.json();
                if (results.length === 0) {
                    showNotification('{% trans "Location not found" %}', 'error');
                    return;
                }
                const { lat, lon } = results[0];
                selectedLat = parseFloat(lat);
                selectedLon = parseFloat(lon);
                map.setView([selectedLat, selectedLon], 14);
                map.fire('click', { latlng: { lat: selectedLat, lng: selectedLon } });
            } catch (error) {
                showNotification(`{% trans "Error searching location" %}: ${error.message}`, 'error');
            } finally {
                spinner.classList.remove('active');
            }
        });

        document.getElementById('goToCoords').addEventListener('click', () => {
            const lat = parseFloat(document.getElementById('latInput').value);
            const lon = parseFloat(document.getElementById('lonInput').value);
            if (isNaN(lat) || isNaN(lon) || lat < -90 || lat > 90 || lon < -180 || lon > 180) {
                showNotification('{% trans "Please enter valid coordinates" %}', 'warning');
                return;
            }
            selectedLat = lat;
            selectedLon = lon;
            map.setView([selectedLat, selectedLon], 14);
            map.fire('click', { latlng: { lat: selectedLat, lng: selectedLon } });
        });
        {% endif %}

        map.on('click', async function(e) {
            const spinner = document.getElementById('loadingSpinner');
            spinner.classList.add('active');
            selectedLat = e.latlng.lat;
            selectedLon = e.latlng.lng;
            const { isWater, displayName } = await checkLocation(selectedLat, selectedLon);
            if (isWater) {
                spinner.classList.remove('active');
                showNotification('{% trans "There is no land at this water location. Please select a valid location." %}', 'error');
                selectedLat = null;
                selectedLon = null;
                updateCoordinatesDisplay();
                return;
            }
            if (marker) map.removeLayer(marker);
            try {
                const cropPreference = document.getElementById('cropPreference').value;
                const today = new Date().toISOString().split('T')[0];
                const [farmResponse, locationResponse] = await Promise.all([
                    fetch('{% url "maps:get-farm-by-coords" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({ latitude: selectedLat, longitude: selectedLon })
                    }),
                    fetch('{% url "maps:get-location-details" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({ latitude: selectedLat, longitude: selectedLon })
                    })
                ]);
                let farmData = null;
                if (farmResponse.status !== 404) {
                    farmData = await farmResponse.json();
                    if (!farmResponse.ok) throw new Error(`Farm fetch error: ${farmResponse.status}`);
                }
                if (!locationResponse.ok) {
                    const errorData = await locationResponse.json();
                    throw new Error(errorData.error || `Location fetch error: ${locationResponse.status}`);
                }
                const locationData = await locationResponse.json();
                if (farmData && farmData.user_crop_preferences) {
                    let priceHtml = '<div class="prediction-error">{% trans "No price prediction available" %}</div>';
                    if (farmData.planting_date) {
                        const priceData = await fetchPricePrediction(farmData.user_crop_preferences, farmData.planting_date, farmData.id);
                        if (priceData && priceData.predicted_price && farmData.yield_per_acre && farmData.area) {
                            priceHtml = `
                                <div class="prediction">
                                    <strong>{% trans "Predicted Price" %} (${priceData.crop}):</strong> ₹${priceData.predicted_price.toFixed(2)}/quintal<br>
                                    <strong>{% trans "Total Yield" %}:</strong> ${priceData.total_yield.toFixed(2)} quintals<br>
                                    <strong>{% trans "Est. Revenue" %}:</strong> ₹${priceData.estimated_revenue.toFixed(2)} (as of ${priceData.date})
                                </div>`;
                        }
                    }
                    const farmName = farmData.farm_name || farmData.farmer;
                    const popupTitle = {% if user.user_type == 'GOVERNMENT' %} `'${farmName} ({{ user.government_profile.organization_name|default:"Government" }})'` {% else %} `'${farmName}'` {% endif %};
                    marker = L.marker([selectedLat, selectedLon], { icon: statusIcons[farmData.status] })
                        .addTo(map)
                        .bindPopup(`
                            <div class="popup-title">${popupTitle}</div>
                            <div class="popup-content">
                                <div><strong>{% trans "Farmer" %}:</strong> ${farmData.farmer}</div>
                                <div><span class="status-indicator status-${farmData.status}"></span> <strong>{% trans "Status" %}:</strong> ${farmData.status.charAt(0).toUpperCase() + farmData.status.slice(1)}</div>
                                <div><strong>{% trans "Size" %}:</strong> ${farmData.area || '{% trans "Not set" %}'} acres</div>
                                <div><strong>{% trans "Soil Type" %}:</strong> ${farmData.soil_type.charAt(0).toUpperCase() + farmData.soil_type.slice(1)}</div>
                                <div><strong>{% trans "Climate" %}:</strong> ${farmData.climate.charAt(0).toUpperCase() + farmData.climate.slice(1)}</div>
                                <div><strong>{% trans "Crop Planted" %}:</strong> ${farmData.user_crop_preferences || '{% trans "None" %}'}</div>
                                <div><strong>{% trans "Planting Date" %}:</strong> ${farmData.planting_date || '{% trans "Not set" %}'}</div>
                                <div><strong>{% trans "Yield/Acre" %}:</strong> ${farmData.yield_per_acre || '{% trans "Not set" %}'} quintals</div>
                                <div><strong>{% trans "Recommended Crop" %}:</strong> ${farmData.recommended_crop || '{% trans "Not Set" %}'}</div>
                                <div><strong>{% trans "Oversupply Risk" %}:</strong> ${farmData.oversupply_risk ? '{% trans "Yes" %}' : '{% trans "No" %}'}</div>
                                <div><strong>{% trans "Coordinates" %}:</strong> Lat: ${selectedLat.toFixed(6)}, Lon: ${selectedLon.toFixed(6)}</div>
                                ${priceHtml}
                                {% if user.user_type != 'NON_PROFIT' %}
                                <button class="more-details-btn" onclick="showMoreDetails(${selectedLat}, ${selectedLon}, this)">{% trans "More Details" %}</button>
                                <div class="more-details-section" id="more-details-${selectedLat}-${selectedLon}">
                                    <div>{% trans "Loading additional data..." %}</div>
                                </div>
                                {% endif %}
                            </div>
                        `)
                        .openPopup();
                } else {
                    let priceHtml = '<div class="prediction-error">{% trans "Select a crop for price prediction" %}</div>';
                    if (cropPreference) {
                        const priceData = await fetchPricePrediction(cropPreference, today);
                        if (priceData && priceData.predicted_price) {
                            priceHtml = `
                                <div class="prediction">
                                    <strong>{% trans "Predicted Price" %} (${priceData.crop}):</strong> ₹${priceData.predicted_price.toFixed(2)}/quintal (as of ${priceData.date})
                                </div>`;
                        }
                    }
                    const popupTitle = {% if user.user_type == 'GOVERNMENT' %} `'Location Insights ({{ user.government_profile.organization_name|default:"Government" }})'` {% else %} `'Location Insights'` {% endif %};
                    marker = L.marker([selectedLat, selectedLon], { icon: customIcon })
                        .addTo(map)
                        .bindPopup(`
                            <div class="popup-title">${popupTitle}</div>
                            <div class="popup-content">
                                {% if user.user_type == 'NON_PROFIT' %}
                                <div><strong>{% trans "Recommended Crop" %}:</strong> ${locationData.recommended_crops[0]?.crop.charAt(0).toUpperCase() + locationData.recommended_crops[0]?.crop.slice(1) || '{% trans "Not Set" %}'}</div>
                                ${priceHtml}
                                <div>{% trans "Click 'Add Farm' to register this location." %}</div>
                                {% else %}
                                <div><strong>{% trans "Temperature" %}:</strong> ${locationData.weather.temperature.toFixed(1)}°C</div>
                                <div><strong>{% trans "Humidity" %}:</strong> ${locationData.weather.humidity.toFixed(0)}%</div>
                                <div><strong>{% trans "Rainfall" %}:</strong> ${locationData.weather.rainfall.toFixed(1)} mm</div>
                                <div><strong>{% trans "Soil Type" %}:</strong> ${locationData.soil.soil_type.charAt(0).toUpperCase() + locationData.soil.soil_type.slice(1)}</div>
                                <div><strong>{% trans "Soil pH" %}:</strong> ${locationData.soil.ph.toFixed(1)}</div>
                                <div><strong>{% trans "Soil NPK" %}:</strong> N:${locationData.soil.N.toFixed(1)}, P:${locationData.soil.P.toFixed(0)}, K:${locationData.soil.K.toFixed(0)}</div>
                                <div><strong>{% trans "Avg Temp" %}:</strong> ${locationData.climate.avg_temp.toFixed(1)}°C</div>
                                <div><strong>{% trans "Avg Rainfall" %}:</strong> ${locationData.climate.avg_rainfall.toFixed(0)} mm</div>
                                <div><strong>{% trans "Recommended Crops" %}:</strong><br>${locationData.recommended_crops.slice(0, 5).map(crop => `${crop.crop.charAt(0).toUpperCase() + crop.crop.slice(1)} (${crop.suitability.toFixed(1)}%)`).join('<br>')}</div>
                                <div><strong>{% trans "Coordinates" %}:</strong> Lat: ${selectedLat.toFixed(6)}, Lon: ${selectedLon.toFixed(6)}</div>
                                ${priceHtml}
                                <div>{% trans "Click 'Add Farm' to register this location." %}</div>
                                <button class="more-details-btn" onclick="showMoreDetails(${selectedLat}, ${selectedLon}, this)">{% trans "More Details" %}</button>
                                <div class="more-details-section" id="more-details-${selectedLat}-${selectedLon}">
                                    <div>{% trans "Loading additional data..." %}</div>
                                </div>
                                {% endif %}
                            </div>
                        `)
                        .openPopup();
                }
                map.setView([selectedLat, selectedLon], 14);
                updateCoordinatesDisplay();
            } catch (error) {
                console.error(`Map click error: ${error.message}`);
                showNotification(`{% trans "Error" %}: ${error.message}`, 'error');
                marker = L.marker([selectedLat, selectedLon], { icon: customIcon })
                    .addTo(map)
                    .bindPopup(`
                        <div class="popup-title">{% trans "New Location" %}</div>
                        <div class="popup-content">
                            Lat: ${selectedLat.toFixed(6)}<br>
                            Lon: ${selectedLon.toFixed(6)}
                        </div>
                    `)
                    .openPopup();
                updateCoordinatesDisplay();
            } finally {
                spinner.classList.remove('active');
            }
        });

        document.getElementById('saveLocation').addEventListener('click', async () => {
            if (selectedLat === null || selectedLon === null) {
                showNotification('{% trans "Please select a location first" %}', 'warning');
                return;
            }
            const btn = document.getElementById('saveLocation');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> {% trans "Saving..." %}';
            btn.disabled = true;
            try {
                const response = await fetch('{% url "maps:save-location" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ latitude: selectedLat, longitude: selectedLon })
                });
                const data = await response.json();
                if (response.ok) {
                    showNotification(data.message, 'success');
                } else {
                    showNotification(data.error || '{% trans "Error saving location" %}', 'error');
                }
            } catch (error) {
                showNotification(`{% trans "Error saving location" %}: ${error.message}`, 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });

        document.getElementById('currentLocation').addEventListener('click', async () => {
            const btn = document.getElementById('currentLocation');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> {% trans "Locating..." %}';
            btn.disabled = true;
            if (navigator.geolocation) {
                try {
                    const position = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject);
                    });
                    selectedLat = position.coords.latitude;
                    selectedLon = position.coords.longitude;
                    const { isWater } = await checkLocation(selectedLat, selectedLon);
                    if (isWater) {
                        showNotification('{% trans "There is no land at this water location. Please select a valid location." %}', 'error');
                        selectedLat = null;
                        selectedLon = null;
                        updateCoordinatesDisplay();
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                        return;
                    }
                    if (marker) map.removeLayer(marker);
                    marker = L.marker([selectedLat, selectedLon], { icon: customIcon })
                        .addTo(map)
                        .bindPopup(`{% trans "Your Location" %}: Lat: ${selectedLat.toFixed(6)}, Lon: ${selectedLon.toFixed(6)}`)
                        .openPopup();
                    map.setView([selectedLat, selectedLon], 14);
                    updateCoordinatesDisplay();
                    showNotification('{% trans "Location updated" %}', 'success');
                } catch (error) {
                    showNotification(`{% trans "Error getting location" %}: ${error.message}`, 'error');
                }
            } else {
                showNotification('{% trans "Geolocation not supported" %}', 'error');
            }
            btn.innerHTML = originalText;
            btn.disabled = false;
        });

        document.getElementById('resetMap').addEventListener('click', () => {
            if (marker) map.removeLayer(marker);
            selectedLat = null;
            selectedLon = null;
            map.setView(mapConfig.defaultView, mapConfig.defaultZoom);
            updateCoordinatesDisplay();
            showNotification('{% trans "Map reset" %}', 'success');
        });

        document.getElementById('addFarm').addEventListener('click', async () => {
            if (selectedLat === null || selectedLon === null) {
                showNotification('{% trans "Please select a location first" %}', 'warning');
                return;
            }
            try {
                const response = await fetch('{% url "maps:get-farm-by-coords" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ latitude: selectedLat, longitude: selectedLon })
                });
                const data = response.status === 404 ? null : await response.json();
                if (data && data.id) {
                    showNotification('{% trans "A farm already exists here" %}', 'warning');
                } else {
                    const modal = document.getElementById('farmModal');
                    const cropSelect = document.getElementById('userCropPreferences');
                    const cropPreference = document.getElementById('cropPreference').value;
                    if (cropPreference) cropSelect.value = cropPreference;
                    const today = new Date().toISOString().split('T')[0];
                    document.getElementById('plantingDate').value = today;
                    modal.style.display = 'block';
                }
            } catch (error) {
                showNotification(`{% trans "Error checking farm" %}: ${error.message}`, 'error');
            }
        });

        document.getElementById('closeFarmModal').addEventListener('click', () => {
            document.getElementById('farmModal').style.display = 'none';
        });

        document.getElementById('cancelFarm').addEventListener('click', () => {
            document.getElementById('farmModal').style.display = 'none';
        });

        document.getElementById('farmForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (selectedLat === null || selectedLon === null) {
                showNotification('{% trans "Please select a location first" %}', 'warning');
                return;
            }
            const formData = {
                latitude: selectedLat,
                longitude: selectedLon,
                area: parseFloat(document.getElementById('farmSize').value),
                status: document.getElementById('farmStatus').value,
                soil_type: document.getElementById('soilType').value,
                climate: document.getElementById('climate').value,
                user_crop_preferences: document.getElementById('userCropPreferences').value,
                planting_date: document.getElementById('plantingDate').value,
                yield_per_acre: parseFloat(document.getElementById('yieldPerAcre').value)
            };
            {% if user.user_type == 'FARMER' %}
            formData.farm_name = '{{ user.farmer_profile.farm_name|default:user.username }}';
            {% endif %}
            const btn = document.getElementById('submitFarm');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> {% trans "Saving..." %}';
            btn.disabled = true;
            try {
                const response = await fetch('{% url "maps:add-farm" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify(formData)
                });
                const data = await response.json();
                if (response.ok) {
                    showNotification(data.message, 'success');
                    document.getElementById('farmModal').style.display = 'none';
                    if (marker) map.removeLayer(marker);
                    const farmName = {% if user.user_type == 'FARMER' %} formData.farm_name {% else %} data.farmer {% endif %};
                    marker = L.marker([selectedLat, selectedLon], { icon: statusIcons[formData.status] })
                        .addTo(map)
                        .bindPopup(`
                            <div class="popup-title">${farmName}</div>
                            <div class="popup-content">
                                <div><strong>{% trans "Farmer" %}:</strong> ${data.farmer}</div>
                                <div><span class="status-indicator status-${formData.status}"></span> <strong>{% trans "Status" %}:</strong> ${formData.status.charAt(0).toUpperCase() + formData.status.slice(1)}</div>
                                <div><strong>{% trans "Size" %}:</strong> ${formData.area} acres</div>
                                <div><strong>{% trans "Soil Type" %}:</strong> ${formData.soil_type.charAt(0).toUpperCase() + formData.soil_type.slice(1)}</div>
                                <div><strong>{% trans "Climate" %}:</strong> ${formData.climate.charAt(0).toUpperCase() + formData.climate.slice(1)}</div>
                                <div><strong>{% trans "Crop Planted" %}:</strong> ${formData.user_crop_preferences}</div>
                                <div><strong>{% trans "Planting Date" %}:</strong> ${formData.planting_date}</div>
                                <div><strong>{% trans "Yield/Acre" %}:</strong> ${formData.yield_per_acre} quintals</div>
                                <div><strong>{% trans "Recommended Crop" %}:</strong> ${data.recommended_crop || '{% trans "Not Set" %}'}</div>
                                <div><strong>{% trans "Oversupply Risk" %}:</strong> ${data.oversupply_risk ? '{% trans "Yes" %}' : '{% trans "No" %}'}</div>
                                <div><strong>{% trans "Coordinates" %}:</strong> Lat: ${selectedLat.toFixed(6)}, Lon: ${selectedLon.toFixed(6)}</div>
                                {% if user.user_type != 'NON_PROFIT' %}
                                <button class="more-details-btn" onclick="showMoreDetails(${selectedLat}, ${selectedLon}, this)">{% trans "More Details" %}</button>
                                <div class="more-details-section" id="more-details-${selectedLat}-${selectedLon}">
                                    <div>{% trans "Loading additional data..." %}</div>
                                </div>
                                {% endif %}
                            </div>
                        `)
                        .openPopup();
                } else {
                    showNotification(data.error || '{% trans "Error adding farm" %}', 'error');
                }
            } catch (error) {
                showNotification(`{% trans "Error adding farm" %}: ${error.message}`, 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });

        async function displayFarms(filterCrop = '', filterStatus = '') {
            const spinner = document.getElementById('loadingSpinner');
            spinner.classList.add('active');
            try {
                const response = await fetch('{% url "maps:get-farm-data" %}');
                if (!response.ok) throw new Error(`Farm data fetch error: ${response.status}`);
                const data = await response.json();
                farmMarkers.forEach(m => map.removeLayer(m));
                farmPolygons.forEach(p => map.removeLayer(p));
                farmMarkers = [];
                farmPolygons = [];
                const bounds = [];
                for (const feature of data.features) {
                    const { coordinates } = feature.geometry;
                    const props = feature.properties;
                    const [lon, lat] = coordinates;
                    {% if user.user_type == 'GOVERNMENT' %}
                    if (filterCrop && props.user_crop_preferences !== filterCrop) continue;
                    if (filterStatus && props.status !== filterStatus) continue;
                    {% endif %}
                    bounds.push([lat, lon]);
                    const farmName = props.farm_name || props.farmer;
                    const popupTitle = {% if user.user_type == 'GOVERNMENT' %} `'${farmName} ({{ user.government_profile.organization_name|default:"Government" }})'` {% else %} `'${farmName}'` {% endif %};
                    const farmMarker = L.marker([lat, lon], { icon: statusIcons[props.status] })
                        .addTo(map)
                        .bindPopup(`
                            <div class="popup-title">${popupTitle}</div>
                            <div class="popup-content">
                                <div><strong>{% trans "Farmer" %}:</strong> ${props.farmer}</div>
                                <div><span class="status-indicator status-${props.status}"></span> <strong>{% trans "Status" %}:</strong> ${props.status.charAt(0).toUpperCase() + props.status.slice(1)}</div>
                                <div><strong>{% trans "Size" %}:</strong> ${props.area || '{% trans "Not set" %}'} acres</div>
                                <div><strong>{% trans "Soil Type" %}:</strong> ${props.soil_type.charAt(0).toUpperCase() + props.soil_type.slice(1)}</div>
                                <div><strong>{% trans "Climate" %}:</strong> ${props.climate.charAt(0).toUpperCase() + props.climate.slice(1)}</div>
                                <div><strong>{% trans "Crop Planted" %}:</strong> ${props.user_crop_preferences || '{% trans "None" %}'}</div>
                                <div><strong>{% trans "Planting Date" %}:</strong> ${props.planting_date || '{% trans "Not set" %}'}</div>
                                <div><strong>{% trans "Yield/Acre" %}:</strong> ${props.yield_per_acre || '{% trans "Not set" %}'} quintals</div>
                                <div><strong>{% trans "Recommended Crop" %}:</strong> ${props.recommended_crop || '{% trans "Not Set" %}'}</div>
                                <div><strong>{% trans "Oversupply Risk" %}:</strong> ${props.oversupply_risk ? '{% trans "Yes" %}' : '{% trans "No" %}'}</div>
                                <div><strong>{% trans "Coordinates" %}:</strong> Lat: ${lat.toFixed(6)}, Lon: ${lon.toFixed(6)}</div>
                                {% if user.user_type != 'NON_PROFIT' %}
                                <button class="more-details-btn" onclick="showMoreDetails(${lat}, ${lon}, this)">{% trans "More Details" %}</button>
                                <div class="more-details-section" id="more-details-${lat}-${lon}">
                                    <div>{% trans "Loading additional data..." %}</div>
                                </div>
                                {% endif %}
                            </div>
                        `);
                    farmMarkers.push(farmMarker);
                    if (props.area) {
                        const side = Math.sqrt(props.area) * 0.1;
                        const polygon = L.rectangle([
                            [lat - side / 2, lon - side / 2],
                            [lat + side / 2, lon + side / 2]
                        ], {
                            color: props.status === 'green' ? '#2ecc71' : props.status === 'orange' ? '#f39c12' : '#e74c3c',
                            weight: 2,
                            opacity: 0.7,
                            fillOpacity: 0.2
                        }).addTo(map);
                        farmPolygons.push(polygon);
                    }
                }
                if (bounds.length > 0) {
                    map.fitBounds(bounds, { padding: [50, 50] });
                } else {
                    map.setView(mapConfig.defaultView, mapConfig.defaultZoom);
                }
                showNotification('{% trans "Farms displayed" %}', 'success');
            } catch (error) {
                showNotification(`{% trans "Error fetching farm data" %}: ${error.message}`, 'error');
            } finally {
                spinner.classList.remove('active');
            }
        }

        {% if user.user_type == 'GOVERNMENT' %}
        document.getElementById('viewAllFarms').addEventListener('click', () => {
            const filterCrop = document.getElementById('filterCrop').value;
            const filterStatus = document.getElementById('filterStatus').value;
            displayFarms(filterCrop, filterStatus);
        });

        document.getElementById('filterCrop').addEventListener('change', () => {
            const filterCrop = document.getElementById('filterCrop').value;
            const filterStatus = document.getElementById('filterStatus').value;
            displayFarms(filterCrop, filterStatus);
        });

        document.getElementById('filterStatus').addEventListener('change', () => {
            const filterCrop = document.getElementById('filterCrop').value;
            const filterStatus = document.getElementById('filterStatus').value;
            displayFarms(filterCrop, filterStatus);
        });

        document.getElementById('exportFarms').addEventListener('click', async () => {
            const spinner = document.getElementById('loadingSpinner');
            spinner.classList.add('active');
            try {
                const response = await fetch('{% url "maps:get-farm-data" %}');
                if (!response.ok) throw new Error(`Farm data fetch error: ${response.status}`);
                const data = await response.json();
                const headers = ['Farmer', 'Farm Name', 'Latitude', 'Longitude', 'Area (acres)', 'Status', 'Soil Type', 'Climate', 'Crop Planted', 'Planting Date', 'Yield/Acre (quintals)', 'Recommended Crop', 'Oversupply Risk'];
                const rows = data.features.map(feature => {
                    const props = feature.properties;
                    const [lon, lat] = feature.geometry.coordinates;
                    return [
                        props.farmer || 'N/A',
                        props.farm_name || 'N/A',
                        lat.toFixed(6),
                        lon.toFixed(6),
                        props.area || 'N/A',
                        props.status.charAt(0).toUpperCase() + props.status.slice(1),
                        props.soil_type.charAt(0).toUpperCase() + props.soil_type.slice(1),
                        props.climate.charAt(0).toUpperCase() + props.climate.slice(1),
                        props.user_crop_preferences || 'None',
                        props.planting_date || 'N/A',
                        props.yield_per_acre || 'N/A',
                        props.recommended_crop || 'N/A',
                        props.oversupply_risk ? 'Yes' : 'No'
                    ].map(field => `"${field.toString().replace(/"/g, '""')}"`).join(',');
                });
                const csvContent = [headers.join(','), ...rows].join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', 'farms_export.csv');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                showNotification('{% trans "Farms exported successfully" %}', 'success');
            } catch (error) {
                showNotification(`{% trans "Error exporting farms" %}: ${error.message}`, 'error');
            } finally {
                spinner.classList.remove('active');
            }
        });
        {% elif user.user_type == 'FARMER' %}
        document.getElementById('viewAllFarms').addEventListener('click', () => {
            displayFarms();
        });

        async function loadInitialFarms() {
            try {
                const response = await fetch('{% url "maps:get-farm-data" %}');
                if (!response.ok) throw new Error(`Initial farm fetch error: ${response.status}`);
                const data = await response.json();
                farmMarkers.forEach(m => map.removeLayer(m));
                farmPolygons.forEach(p => map.removeLayer(p));
                farmMarkers = [];
                farmPolygons = [];
                const bounds = [];
                for (const feature of data.features) {
                    const { coordinates } = feature.geometry;
                    const props = feature.properties;
                    const [lon, lat] = coordinates;
                    bounds.push([lat, lon]);
                    const farmName = props.farm_name || props.farmer;
                    const farmMarker = L.marker([lat, lon], { icon: statusIcons[props.status] })
                        .addTo(map)
                        .bindPopup(`
                            <div class="popup-title">${farmName}</div>
                            <div class="popup-content">
                                <div><strong>{% trans "Farmer" %}:</strong> ${props.farmer}</div>
                                <div><span class="status-indicator status-${props.status}"></span> <strong>{% trans "Status" %}:</strong> ${props.status.charAt(0).toUpperCase() + props.status.slice(1)}</div>
                                <div><strong>{% trans "Size" %}:</strong> ${props.area || '{% trans "Not set" %}'} acres</div>
                                <div><strong>{% trans "Soil Type" %}:</strong> ${props.soil_type.charAt(0).toUpperCase() + props.soil_type.slice(1)}</div>
                                <div><strong>{% trans "Climate" %}:</strong> ${props.climate.charAt(0).toUpperCase() + props.climate.slice(1)}</div>
                                <div><strong>{% trans "Crop Planted" %}:</strong> ${props.user_crop_preferences || '{% trans "None" %}'}</div>
                                <div><strong>{% trans "Planting Date" %}:</strong> ${props.planting_date || '{% trans "Not set" %}'}</div>
                                <div><strong>{% trans "Yield/Acre" %}:</strong> ${props.yield_per_acre || '{% trans "Not set" %}'} quintals</div>
                                <div><strong>{% trans "Recommended Crop" %}:</strong> ${props.recommended_crop || '{% trans "Not Set" %}'}</div>
                                <div><strong>{% trans "Oversupply Risk" %}:</strong> ${props.oversupply_risk ? '{% trans "Yes" %}' : '{% trans "No" %}'}</div>
                                <div><strong>{% trans "Coordinates" %}:</strong> Lat: ${lat.toFixed(6)}, Lon: ${lon.toFixed(6)}</div>
                                <button class="more-details-btn" onclick="showMoreDetails(${lat}, ${lon}, this)">{% trans "More Details" %}</button>
                                <div class="more-details-section" id="more-details-${lat}-${lon}">
                                    <div>{% trans "Loading additional data..." %}</div>
                                </div>
                            </div>
                        `);
                    farmMarkers.push(farmMarker);
                    if (props.area) {
                        const side = Math.sqrt(props.area) * 0.1;
                        const polygon = L.rectangle([
                            [lat - side / 2, lon - side / 2],
                            [lat + side / 2, lon + side / 2]
                        ], {
                            color: props.status === 'green' ? '#2ecc71' : props.status === 'orange' ? '#f39c12' : '#e74c3c',
                            weight: 2,
                            opacity: 0.7,
                            fillOpacity: 0.2
                        }).addTo(map);
                        farmPolygons.push(polygon);
                    }
                }
                if (bounds.length > 0) {
                    map.fitBounds(bounds, { padding: [50, 50] });
                }
            } catch (error) {
                console.error(`Error loading initial farms: ${error.message}`);
            }
        }

        loadInitialFarms();
        {% endif %}
    </script>
{% endblock %}