{% extends 'base.html' %}
{% load static i18n %}

{% block title %}{% trans "Smart Farm Map" %}{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        main { padding: 0; margin: 0; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { background: linear-gradient(135deg, #3498db, #2ecc71); color: white; padding: 20px 0; border-radius: 0 0 15px 15px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); margin-bottom: 20px; }
        h2 { margin: 0; font-size: 28px; letter-spacing: 0.5px; }
        .subtitle { font-size: 16px; opacity: 0.9; margin-top: 5px; }
        #map { height: 500px; width: 100%; border-radius: 15px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); margin-bottom: 20px; }
        .crop-selector-container { margin-bottom: 20px; display: flex; justify-content: center; }
        #cropPreference { padding: 10px; border-radius: 5px; font-size: 16px; width: 200px; border: 1px solid #ddd; }
        .button-container { display: flex; justify-content: center; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; }
        button { padding: 12px 16px; border: none; cursor: pointer; border-radius: 8px; background-color: #3498db; color: white; font-size: 15px; transition: all 0.3s ease; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); display: flex; align-items: center; gap: 8px; }
        button:hover { background-color: #2980b9; transform: translateY(-2px); }
        button:active { transform: translateY(0); }
        button:disabled { background-color: #95a5a6; cursor: not-allowed; transform: none; }
        button.warning { background-color: #f39c12; }
        button.warning:hover { background-color: #e67e22; }
        .map-container { position: relative; }
        .legend { position: absolute; z-index: 1000; bottom: 30px; right: 30px; background: white; padding: 10px 15px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); font-size: 14px; }
        .legend-item { display: flex; align-items: center; margin: 5px 0; }
        .legend-color { width: 20px; height: 20px; border-radius: 50%; margin-right: 10px; }
        #coordinates-panel { background: white; padding: 12px 15px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .coordinates-info { font-size: 15px; }
        .coordinates-value { font-weight: bold; color: #3498db; }
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); overflow: auto; }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 80%; max-width: 600px; animation: modalopen 0.3s; }
        @keyframes modalopen { from {opacity: 0; transform: translateY(-50px);} to {opacity: 1; transform: translateY(0);} }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
        .modal-title { font-size: 20px; font-weight: bold; color: #2980b9; }
        .close-button { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; transition: color 0.3s; }
        .close-button:hover { color: #333; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #2c3e50; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; transition: border-color 0.3s; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #3498db; box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2); }
        .form-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .leaflet-popup-content-wrapper { border-radius: 10px; padding: 5px; }
        .leaflet-popup-content { margin: 10px 12px; line-height: 1.5; }
        .popup-title { font-weight: bold; margin-bottom: 5px; font-size: 16px; color: #2980b9; }
        .popup-content { font-size: 14px; }
        .prediction { margin-top: 10px; font-weight: bold; color: #2ecc71; }
        .prediction-error { color: #e74c3c; }
        .status-indicator { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 5px; }
        .status-green { background-color: #2ecc71; }
        .status-orange { background-color: #f39c12; }
        .status-red { background-color: #e74c3c; }
        .notification { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); z-index: 9999; opacity: 0; transition: opacity 0.3s ease-in-out; color: white; display: flex; align-items: center; gap: 10px; }
        .notification.show { opacity: 1; }
        .notification.success { background-color: #3498db; }
        .notification.error { background-color: #e74c3c; }
        .notification.warning { background-color: #f39c12; }
        .loading-spinner { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; display: none; padding: 25px; background: rgba(0, 0, 0, 0.85); border-radius: 15px; box-shadow: 0 0 20px rgba(0, 255, 255, 0.5); }
        .loading-spinner.active { display: flex; align-items: center; justify-content: center; gap: 10px; }
        .spinner-ring { width: 40px; height: 40px; border: 4px solid transparent; border-top: 4px solid #00ffff; border-right: 4px solid #00ccff; border-radius: 50%; animation: spin 1s linear infinite; }
        .spinner-text { color: #00ffff; font-size: 16px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .more-details-btn { background-color: #2980b9; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; margin-top: 10px; }
        .more-details-btn:hover { background-color: #1f6391; }
        .more-details-section { display: none; margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd; }
        .more-details-section.active { display: block; }
        @media (max-width: 768px) { #map { height: 400px; } .button-container { justify-content: center; } button { padding: 10px 14px; font-size: 14px; } .modal-content { width: 90%; margin: 20% auto; } }
        @media (max-width: 600px) { .header { padding: 15px 0; } h2 { font-size: 22px; } .subtitle { font-size: 14px; } #map { height: 350px; } .button-container { flex-direction: column; gap: 8px; } button { width: 100%; justify-content: center; } .legend { bottom: 15px; right: 15px; padding: 8px 12px; font-size: 12px; } }
    </style>
{% endblock %}

{% block content %}
    <main>
        <div class="header">
            <div class="container">
                <h2>{% trans "Smart Farm Mapping System" %}</h2>
                <div class="subtitle">{% trans "Optimize your farming with location-based crop suggestions and price predictions" %}</div>
            </div>
        </div>

        <div class="container">
            <div class="crop-selector-container">
                <select id="cropPreference">
                    <option value="">{% trans "Select Crop" %}</option>
                    <option value="coconut_Kochi">{% trans "Coconut (Kochi)" %}</option>
                    <option value="pepper_Kochi">{% trans "Pepper (Kochi)" %}</option>
                    <option value="rubber_Kochi">{% trans "Rubber (Kochi)" %}</option>
                    <option value="tapioca_Kochi">{% trans "Tapioca (Kochi)" %}</option>
                    <option value="turmeric_Kochi">{% trans "Turmeric (Kochi)" %}</option>
                </select>
            </div>

            <div id="coordinates-panel">
                <div class="coordinates-info">{% trans "Selected Location" %}: <span id="selected-location-text">{% trans "No location selected" %}</span></div>
                <div class="coordinates-value" id="coordinates-display"></div>
            </div>
            
            <div class="button-container">
                <button id="saveLocation"><i class="fas fa-save"></i> {% trans "Save Location" %}</button>
                <button id="currentLocation"><i class="fas fa-location-arrow"></i> {% trans "Use My Location" %}</button>
                <button id="resetMap" class="warning"><i class="fas fa-sync-alt"></i> {% trans "Reset Map" %}</button>
                <button id="addFarm"><i class="fas fa-plus"></i> {% trans "Add Farm" %}</button>
                <button id="viewAllFarms"><i class="fas fa-eye"></i> {% trans "View All Farms" %}</button>
                <a href="{% url 'my_farms' %}" class="btn btn-primary"><i class="fas fa-tractor"></i> {% trans "My Farms" %}</a>
            </div>
            
            <div class="map-container">
                <div id="map"></div>
                <div class="loading-spinner" id="loadingSpinner">
                    <div class="spinner-ring"></div>
                    <span class="spinner-text">{% trans "Processing..." %}</span>
                </div>
                <div class="legend">
                    <div class="legend-item"><div class="legend-color status-green"></div> {% trans "Good Condition" %}</div>
                    <div class="legend-item"><div class="legend-color status-orange"></div> {% trans "Moderate Risk" %}</div>
                    <div class="legend-item"><div class="legend-color status-red"></div> {% trans "High Risk" %}</div>
                </div>
            </div>

            <div id="farmModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <span class="modal-title">{% trans "Add New Farm" %}</span>
                        <span class="close-button" id="closeFarmModal">×</span>
                    </div>
                    <form id="farmForm">
                        <div class="form-group">
                            <label for="farmSize">{% trans "Farm Size (acres/hectares)" %}</label>
                            <input type="number" id="farmSize" name="farmSize" min="0" step="0.1" value="1.0" required>
                        </div>
                        <div class="form-group">
                            <label for="farmStatus">{% trans "Farm Status" %}</label>
                            <select id="farmStatus" name="farmStatus" required>
                                <option value="green">{% trans "Good Condition" %}</option>
                                <option value="orange">{% trans "Moderate Risk" %}</option>
                                <option value="red">{% trans "High Risk" %}</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="soilType">{% trans "Soil Type" %}</label>
                            <select id="soilType" name="soilType" required>
                                <option value="loamy">{% trans "Loamy" %}</option>
                                <option value="clay">{% trans "Clay" %}</option>
                                <option value="sandy">{% trans "Sandy" %}</option>
                                <option value="silt">{% trans "Silt" %}</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="climate">{% trans "Climate" %}</label>
                            <select id="climate" name="climate" required>
                                <option value="hot">{% trans "Hot" %}</option>
                                <option value="tropical">{% trans "Tropical" %}</option>
                                <option value="subtropical">{% trans "Subtropical" %}</option>
                                <option value="temperate">{% trans "Temperate" %}</option>
                                <option value="arid">{% trans "Arid" %}</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="userCropPreferences">{% trans "Preferred Crop" %}</label>
                            <select id="userCropPreferences" name="userCropPreferences">
                                <option value="">{% trans "None" %}</option>
                                {% for value, label in Farm.CROP_CHOICES %}
                                    <option value="{{ value }}">{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>{% trans "Farm Location" %}</label>
                            <div id="locationDisplay">{% trans "Please select a location on the map first" %}</div>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="warning" id="cancelFarm">{% trans "Cancel" %}</button>
                            <button type="submit" id="submitFarm">{% trans "Save Farm" %}</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>
{% endblock %}

{% block extra_js %}
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const mapConfig = {
            defaultView: [20.5937, 78.9629],
            defaultZoom: 5,
            maxZoom: 18
        };
        const map = L.map('map').setView(mapConfig.defaultView, mapConfig.defaultZoom);
        let marker = null;
        let selectedLat = null;
        let selectedLon = null;
        let farmMarkers = [];
        let farmPolygons = [];

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
        }).addTo(map);

        const customIcon = L.icon({
            iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-icon.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
            shadowSize: [41, 41]
        });

        const statusIcons = {
            green: L.icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34]
            }),
            orange: L.icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-orange.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34]
            }),
            red: L.icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34]
            })
        };

        function showNotification(message, type = "success") {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-exclamation-triangle'}"></i> ${message}`;
            document.body.appendChild(notification);
            setTimeout(() => notification.classList.add('show'), 10);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function updateCoordinatesDisplay() {
            const coordinatesDisplay = document.getElementById('coordinates-display');
            const selectedLocationText = document.getElementById('selected-location-text');
            const locationDisplay = document.getElementById('locationDisplay');
            if (selectedLat !== null && selectedLon !== null) {
                coordinatesDisplay.textContent = `Lat: ${selectedLat.toFixed(6)}, Lon: ${selectedLon.toFixed(6)}`;
                selectedLocationText.textContent = '{% trans "Location Selected" %}';
                if (locationDisplay) {
                    locationDisplay.textContent = `Lat: ${selectedLat.toFixed(6)}, Lon: ${selectedLon.toFixed(6)}`;
                    locationDisplay.style.color = '#2980b9';
                    locationDisplay.style.fontWeight = 'bold';
                }
            } else {
                coordinatesDisplay.textContent = '';
                selectedLocationText.textContent = '{% trans "No location selected" %}';
                if (locationDisplay) locationDisplay.textContent = '{% trans "Please select a location on the map first" %}';
            }
        }

        async function fetchPricePrediction(crop) {
            const spinner = document.getElementById('loadingSpinner');
            spinner.classList.add('active');
            try {
                const response = await fetch('{% url "get-price-prediction" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ crop: crop || 'coconut_Kochi' })
                });
                if (!response.ok) throw new Error(`Price fetch error: ${response.status}`);
                return await response.json();
            } catch (error) {
                showNotification(`{% trans "Error fetching price prediction" %}: ${error.message}`, "error");
                return null;
            } finally {
                spinner.classList.remove('active');
            }
        }

        async function fetchMoreDetails(lat, lon) {
            try {
                const response = await fetch('{% url "get_location_details" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ latitude: lat, longitude: lon, more_details: true })
                });
                if (!response.ok) throw new Error(`Details fetch error: ${response.status}`);
                return await response.json();
            } catch (error) {
                showNotification(`{% trans "Error fetching more details" %}: ${error.message}`, "error");
                return null;
            }
        }

        async function showMoreDetails(lat, lon, button) {
            const section = document.getElementById(`more-details-${lat}-${lon}`);
            if (section.classList.contains('active')) {
                section.classList.remove('active');
                button.textContent = '{% trans "More Details" %}';
                return;
            }
            button.textContent = '{% trans "Loading..." %}';
            const data = await fetchMoreDetails(lat, lon);
            if (data) {
                section.innerHTML = `
                    <div><strong>{% trans "Soil Moisture" %}:</strong> ${data.soil.moisture || 'N/A'}%</div>
                    <div><strong>{% trans "Sunlight Hours" %}:</strong> ${data.climate.sunlight_hours || 'N/A'} hrs</div>
                    <div><strong>{% trans "Pest Risk" %}:</strong> ${data.pest_risk || 'N/A'}</div>
                    <div><strong>{% trans "Water Availability" %}:</strong> ${data.water_availability || 'N/A'} L</div>
                    <div><strong>{% trans "Elevation" %}:</strong> ${data.elevation || 'N/A'} m</div>
                    <div><strong>{% trans "Wind Speed" %}:</strong> ${data.weather.wind_speed || 'N/A'} m/s</div>
                `;
                section.classList.add('active');
                button.textContent = '{% trans "Hide Details" %}';
            } else {
                section.innerHTML = `<div>{% trans "Failed to load data" %}.</div>`;
                section.classList.add('active');
                button.textContent = '{% trans "More Details" %}';
            }
        }

        map.on('click', async function(e) {
            const spinner = document.getElementById('loadingSpinner');
            spinner.classList.add('active');

            if (marker) map.removeLayer(marker);
            selectedLat = e.latlng.lat;
            selectedLon = e.latlng.lng;

            try {
                const cropPreference = document.getElementById('cropPreference').value;
                const [farmResponse, locationResponse, priceData] = await Promise.all([
                    fetch('{% url "get_farm_by_coords" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({ latitude: selectedLat, longitude: selectedLon })
                    }),
                    fetch('{% url "get_location_details" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({ latitude: selectedLat, longitude: selectedLon })
                    }),
                    cropPreference ? fetchPricePrediction(cropPreference) : Promise.resolve(null)
                ]);

                let farmData = null;
                if (farmResponse.status !== 404) {
                    farmData = await farmResponse.json();
                    if (!farmResponse.ok) throw new Error(`Farm fetch error: ${farmResponse.status}`);
                }

                if (!locationResponse.ok) throw new Error(`Location fetch error: ${locationResponse.status}`);
                const locationData = await locationResponse.json();

                if (farmData) {
                    marker = L.marker([selectedLat, selectedLon], { icon: statusIcons[farmData.status] })
                        .addTo(map)
                        .bindPopup(`
                            <div class="popup-title">${farmData.farmer_name}'s Farm</div>
                            <div class="popup-content">
                                <div><strong>{% trans "Farmer" %}:</strong> ${farmData.farmer_name}</div>
                                <div><span class="status-indicator status-${farmData.status}"></span> <strong>{% trans "Status" %}:</strong> ${farmData.status.charAt(0).toUpperCase() + farmData.status.slice(1)}</div>
                                <div><strong>{% trans "Size" %}:</strong> ${farmData.area || '{% trans "Not set" %}'} acres/hectares</div>
                                <div><strong>{% trans "Soil Type" %}:</strong> ${farmData.soil_type.charAt(0).toUpperCase() + farmData.soil_type.slice(1)}</div>
                                <div><strong>{% trans "Climate" %}:</strong> ${farmData.climate.charAt(0).toUpperCase() + farmData.climate.slice(1)}</div>
                                <div><strong>{% trans "Preferred Crop" %}:</strong> ${farmData.user_crop_preferences || '{% trans "None" %}'}</div>
                                <div><strong>{% trans "Recommended Crop" %}:</strong> ${farmData.recommended_crop ? farmData.recommended_crop.charAt(0).toUpperCase() + farmData.recommended_crop.slice(1) : '{% trans "Not Set" %}'}</div>
                                <div><strong>{% trans "Oversupply Risk" %}:</strong> ${farmData.oversupply_risk ? '{% trans "Yes" %}' : '{% trans "No" %}'}</div>
                                <div><strong>{% trans "Coordinates" %}:</strong> Lat: ${selectedLat.toFixed(6)}, Lon: ${selectedLon.toFixed(6)}</div>
                            </div>
                        `)
                        .openPopup();
                } else {
                    const priceHtml = priceData
                        ? `<div class="prediction"><strong>{% trans "Predicted Price" %} (${priceData.crop.replace('_Kochi', '')}):</strong> ₹${priceData.predicted_price.toFixed(2)} (as of ${priceData.date})</div>`
                        : `<div class="prediction-error">{% trans "Select a crop for price prediction" %}</div>`;

                    marker = L.marker([selectedLat, selectedLon], { icon: customIcon })
                        .addTo(map)
                        .bindPopup(`
                            <div class="popup-title">{% trans "Location Insights" %}</div>
                            <div class="popup-content">
                                <div><strong>{% trans "Temperature" %}:</strong> ${locationData.weather.temperature}°C</div>
                                <div><strong>{% trans "Humidity" %}:</strong> ${locationData.weather.humidity}%</div>
                                <div><strong>{% trans "Rainfall" %}:</strong> ${locationData.weather.rainfall} mm</div>
                                <div><strong>{% trans "Soil Type" %}:</strong> ${locationData.soil.soil_type.charAt(0).toUpperCase() + locationData.soil.soil_type.slice(1)}</div>
                                <div><strong>{% trans "Soil pH" %}:</strong> ${locationData.soil.ph}</div>
                                <div><strong>{% trans "Soil NPK" %}:</strong> N:${locationData.soil.N}, P:${locationData.soil.P}, K:${locationData.soil.K}</div>
                                <div><strong>{% trans "Avg Temp" %}:</strong> ${locationData.climate.avg_temp}°C</div>
                                <div><strong>{% trans "Avg Rainfall" %}:</strong> ${locationData.climate.avg_rainfall} mm</div>
                                <div><strong>{% trans "Recommended Crops" %}:</strong><br>${locationData.recommended_crops.slice(0, 7).map(crop => `${crop.crop.charAt(0).toUpperCase() + crop.crop.slice(1)} (${crop.suitability.toFixed(1)}%)`).join('<br>')}</div>
                                <div><strong>{% trans "Coordinates" %}:</strong> Lat: ${selectedLat.toFixed(6)}, Lon: ${selectedLon.toFixed(6)}</div>
                                ${priceHtml}
                                <div>{% trans "Click 'Add Farm' to register this location." %}</div>
                                <button class="more-details-btn" onclick="showMoreDetails(${selectedLat}, ${selectedLon}, this)">{% trans "More Details" %}</button>
                                <div class="more-details-section" id="more-details-${selectedLat}-${selectedLon}">
                                    <div>{% trans "Loading additional data..." %}</div>
                                </div>
                            </div>
                        `)
                        .openPopup();
                }
                map.setView([selectedLat, selectedLon], 14);
                updateCoordinatesDisplay();
            } catch (error) {
                showNotification(`{% trans "Error" %}: ${error.message}`, "error");
                marker = L.marker([selectedLat, selectedLon], { icon: customIcon })
                    .addTo(map)
                    .bindPopup(`
                        <div class="popup-title">{% trans "New Location" %}</div>
                        <div class="popup-content">
                            Lat: ${selectedLat.toFixed(6)}<br>
                            Lon: ${selectedLon.toFixed(6)}
                        </div>
                    `)
                    .openPopup();
                updateCoordinatesDisplay();
            } finally {
                spinner.classList.remove('active');
            }
        });

        document.getElementById('saveLocation').addEventListener('click', async () => {
            if (selectedLat === null || selectedLon === null) {
                showNotification('{% trans "Please select a location first" %}', 'warning');
                return;
            }
            const btn = document.getElementById('saveLocation');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> {% trans "Saving..." %}';
            btn.disabled = true;
            try {
                const response = await fetch('{% url "save_location" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ latitude: selectedLat, longitude: selectedLon })
                });
                const data = await response.json();
                showNotification(data.message, 'success');
            } catch (error) {
                showNotification(`{% trans "Error saving location" %}: ${error.message}`, 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });

        document.getElementById('currentLocation').addEventListener('click', async () => {
            const btn = document.getElementById('currentLocation');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> {% trans "Locating..." %}';
            btn.disabled = true;
            if (navigator.geolocation) {
                try {
                    const position = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject);
                    });
                    selectedLat = position.coords.latitude;
                    selectedLon = position.coords.longitude;
                    if (marker) map.removeLayer(marker);
                    marker = L.marker([selectedLat, selectedLon], { icon: customIcon })
                        .addTo(map)
                        .bindPopup(`{% trans "Your Location" %}: Lat: ${selectedLat.toFixed(6)}, Lon: ${selectedLon.toFixed(6)}`)
                        .openPopup();
                    map.setView([selectedLat, selectedLon], 14);
                    updateCoordinatesDisplay();
                    showNotification('{% trans "Location updated" %}');
                } catch (error) {
                    showNotification(`{% trans "Error getting location" %}: ${error.message}`, 'error');
                }
            } else {
                showNotification('{% trans "Geolocation not supported" %}', 'error');
            }
            btn.innerHTML = originalText;
            btn.disabled = false;
        });

        document.getElementById('resetMap').addEventListener('click', () => {
            if (marker) map.removeLayer(marker);
            selectedLat = null;
            selectedLon = null;
            map.setView(mapConfig.defaultView, mapConfig.defaultZoom);
            updateCoordinatesDisplay();
        });

        document.getElementById('addFarm').addEventListener('click', async () => {
            if (selectedLat === null || selectedLon === null) {
                showNotification('{% trans "Please select a location first" %}', 'warning');
                return;
            }
            try {
                const response = await fetch('{% url "get_farm_by_coords" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ latitude: selectedLat, longitude: selectedLon })
                });
                const data = response.status === 404 ? null : await response.json();
                if (data && data.id) {
                    showNotification('{% trans "A farm already exists here" %}', 'warning');
                } else {
                    const modal = document.getElementById('farmModal');
                    const cropSelect = document.getElementById('userCropPreferences');
                    const cropPreference = document.getElementById('cropPreference').value;
                    if (cropPreference) cropSelect.value = cropPreference;
                    modal.style.display = 'block';
                }
            } catch (error) {
                showNotification(`{% trans "Error checking farm" %}: ${error.message}`, 'error');
            }
        });

        document.getElementById('viewAllFarms').addEventListener('click', async () => {
            try {
                const response = await fetch('{% url "get_farm_data" %}');
                const data = await response.json();
                farmMarkers.forEach(m => map.removeLayer(m));
                farmPolygons.forEach(p => map.removeLayer(p));
                farmMarkers = [];
                farmPolygons = [];
                data.features.forEach(farm => {
                    const latlng = [farm.geometry.coordinates[1], farm.geometry.coordinates[0]];
                    const marker = L.marker(latlng, { icon: statusIcons[farm.properties.status] })
                        .addTo(map)
                        .bindPopup(`
                            <div class="popup-title">${farm.properties.farmer_name}'s Farm</div>
                            <div class="popup-content">
                                <div><strong>{% trans "Farmer" %}:</strong> ${farm.properties.farmer_name}</div>
                                <div><span class="status-indicator status-${farm.properties.status}"></span> <strong>{% trans "Status" %}:</strong> ${farm.properties.status.charAt(0).toUpperCase() + farm.properties.status.slice(1)}</div>
                                <div><strong>{% trans "Size" %}:</strong> ${farm.properties.area || '{% trans "Not set" %}'} acres/hectares</div>
                                <div><strong>{% trans "Soil Type" %}:</strong> ${farm.properties.soil_type.charAt(0).toUpperCase() + farm.properties.soil_type.slice(1)}</div>
                                <div><strong>{% trans "Climate" %}:</strong> ${farm.properties.climate.charAt(0).toUpperCase() + farm.properties.climate.slice(1)}</div>
                                <div><strong>{% trans "Preferred Crop" %}:</strong> ${farm.properties.user_crop_preferences || '{% trans "None" %}'}</div>
                                <div><strong>{% trans "Recommended Crop" %}:</strong> ${farm.properties.recommended_crop ? farm.properties.recommended_crop.charAt(0).toUpperCase() + farm.properties.recommended_crop.slice(1) : '{% trans "Not Set" %}'}</div>
                                <div><strong>{% trans "Oversupply Risk" %}:</strong> ${farm.properties.oversupply_risk ? '{% trans "Yes" %}' : '{% trans "No" %}'}</div>
                                <div><strong>{% trans "Coordinates" %}:</strong> Lat: ${latlng[0].toFixed(6)}, Lon: ${latlng[1].toFixed(6)}</div>
                            </div>
                        `);
                    farmMarkers.push(marker);
                    const polygon = L.polygon([
                        [latlng[0] - 0.001, latlng[1] - 0.001],
                        [latlng[0] + 0.001, latlng[1] - 0.001],
                        [latlng[0] + 0.001, latlng[1] + 0.001],
                        [latlng[0] - 0.001, latlng[1] + 0.001]
                    ], {
                        color: farm.properties.status === 'green' ? '#2ecc71' : farm.properties.status === 'orange' ? '#f39c12' : '#e74c3c',
                        fillOpacity: 0.2
                    }).addTo(map);
                    farmPolygons.push(polygon);
                });
                if (farmMarkers.length > 0) {
                    const bounds = L.latLngBounds(farmMarkers.map(m => m.getLatLng()));
                    map.fitBounds(bounds, { padding: [50, 50] });
                    showNotification('{% trans "Loaded all farms" %}', 'success');
                } else {
                    showNotification('{% trans "No farms to display" %}', 'warning');
                }
            } catch (error) {
                showNotification(`{% trans "Error loading farms" %}: ${error.message}`, 'error');
            }
        });

        const farmModal = document.getElementById('farmModal');
        const closeFarmModal = document.getElementById('closeFarmModal');
        const cancelFarm = document.getElementById('cancelFarm');

        closeFarmModal.addEventListener('click', () => {
            farmModal.style.display = 'none';
        });

        cancelFarm.addEventListener('click', () => {
            farmModal.style.display = 'none';
        });

        window.onclick = (event) => {
            if (event.target === farmModal) {
                farmModal.style.display = 'none';
            }
        };

        document.getElementById('farmForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const farmSize = document.getElementById('farmSize').value;
            const farmStatus = document.getElementById('farmStatus').value;
            const soilType = document.getElementById('soilType').value;
            const climate = document.getElementById('climate').value;
            const userCropPreferences = document.getElementById('userCropPreferences').value;

            if (farmSize <= 0) {
                showNotification('{% trans "Farm size must be positive" %}', 'error');
                return;
            }

            const btn = document.getElementById('submitFarm');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> {% trans "Saving..." %}';
            btn.disabled = true;

            try {
                const response = await fetch('{% url "add_farm" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        farmSize,
                        farmStatus,
                        soilType,
                        climate,
                        latitude: selectedLat,
                        longitude: selectedLon,
                        user_crop_preferences: userCropPreferences || null
                    })
                });
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                showNotification(data.message, 'success');
                farmModal.style.display = 'none';

                const marker = L.marker([selectedLat, selectedLon], { icon: statusIcons[farmStatus] })
                    .addTo(map)
                    .bindPopup(`
                        <div class="popup-title">{% trans "New Farm" %}</div>
                        <div class="popup-content">
                            <div><strong>{% trans "Farmer" %}:</strong> {{ user.username|default:"Anonymous" }}</div>
                            <div><span class="status-indicator status-${farmStatus}"></span> <strong>{% trans "Status" %}:</strong> ${farmStatus.charAt(0).toUpperCase() + farmStatus.slice(1)}</div>
                            <div><strong>{% trans "Size" %}:</strong> ${farmSize} acres/hectares</div>
                            <div><strong>{% trans "Soil Type" %}:</strong> ${soilType.charAt(0).toUpperCase() + soilType.slice(1)}</div>
                            <div><strong>{% trans "Climate" %}:</strong> ${climate.charAt(0).toUpperCase() + climate.slice(1)}</div>
                            <div><strong>{% trans "Preferred Crop" %}:</strong> ${userCropPreferences || '{% trans "None" %}'}</div>
                            <div><strong>{% trans "Recommended Crops" %}:</strong><br>${data.recommended_crops.slice(0, 7).map(crop => `${crop.crop.charAt(0).toUpperCase() + crop.crop.slice(1)} (${crop.suitability.toFixed(1)}%)`).join('<br>')}</div>
                            <div><strong>{% trans "Coordinates" %}:</strong> Lat: ${selectedLat.toFixed(6)}, Lon: ${selectedLon.toFixed(6)}</div>
                        </div>
                    `);
                farmMarkers.push(marker);

                const polygon = L.polygon([
                    [selectedLat - 0.001, selectedLon - 0.001],
                    [selectedLat + 0.001, selectedLon - 0.001],
                    [selectedLat + 0.001, selectedLon + 0.001],
                    [selectedLat - 0.001, selectedLon + 0.001]
                ], {
                    color: farmStatus === 'green' ? '#2ecc71' : farmStatus === 'orange' ? '#f39c12' : '#e74c3c',
                    fillOpacity: 0.2
                }).addTo(map);
                farmPolygons.push(polygon);
            } catch (error) {
                showNotification(`{% trans "Error adding farm" %}: ${error.message}`, 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });

        async function loadFarmData() {
            try {
                const response = await fetch('{% url "get_farm_data" %}');
                const data = await response.json();
                farmMarkers.forEach(m => map.removeLayer(m));
                farmPolygons.forEach(p => map.removeLayer(p));
                farmMarkers = [];
                farmPolygons = [];
                data.features.forEach(farm => {
                    const latlng = [farm.geometry.coordinates[1], farm.geometry.coordinates[0]];
                    const marker = L.marker(latlng, { icon: statusIcons[farm.properties.status] })
                        .addTo(map)
                        .bindPopup(`
                            <div class="popup-title">${farm.properties.farmer_name}'s Farm</div>
                            <div class="popup-content">
                                <div><strong>{% trans "Farmer" %}:</strong> ${farm.properties.farmer_name}</div>
                                <div><span class="status-indicator status-${farm.properties.status}"></span> <strong>{% trans "Status" %}:</strong> ${farm.properties.status.charAt(0).toUpperCase() + farm.properties.status.slice(1)}</div>
                                <div><strong>{% trans "Size" %}:</strong> ${farm.properties.area || '{% trans "Not set" %}'} acres/hectares</div>
                                <div><strong>{% trans "Soil Type" %}:</strong> ${farm.properties.soil_type.charAt(0).toUpperCase() + farm.properties.soil_type.slice(1)}</div>
                                <div><strong>{% trans "Climate" %}:</strong> ${farm.properties.climate.charAt(0).toUpperCase() + farm.properties.climate.slice(1)}</div>
                                <div><strong>{% trans "Preferred Crop" %}:</strong> ${farm.properties.user_crop_preferences || '{% trans "None" %}'}</div>
                                <div><strong>{% trans "Recommended Crop" %}:</strong> ${farm.properties.recommended_crop ? farm.properties.recommended_crop.charAt(0).toUpperCase() + farm.properties.recommended_crop.slice(1) : '{% trans "Not Set" %}'}</div>
                                <div><strong>{% trans "Oversupply Risk" %}:</strong> ${farm.properties.oversupply_risk ? '{% trans "Yes" %}' : '{% trans "No" %}'}</div>
                                <div><strong>{% trans "Coordinates" %}:</strong> Lat: ${latlng[0].toFixed(6)}, Lon: ${latlng[1].toFixed(6)}</div>
                            </div>
                        `);
                    farmMarkers.push(marker);
                    const polygon = L.polygon([
                        [latlng[0] - 0.001, latlng[1] - 0.001],
                        [latlng[0] + 0.001, latlng[1] - 0.001],
                        [latlng[0] + 0.001, latlng[1] + 0.001],
                        [latlng[0] - 0.001, latlng[1] + 0.001]
                    ], {
                        color: farm.properties.status === 'green' ? '#2ecc71' : farm.properties.status === 'orange' ? '#f39c12' : '#e74c3c',
                        fillOpacity: 0.2
                    }).addTo(map);
                    farmPolygons.push(polygon);
                });
            } catch (error) {
                showNotification(`{% trans "Error loading farms" %}: ${error.message}`, 'error');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadFarmData();
            updateCoordinatesDisplay();
        });
    </script>
{% endblock %}